<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RouteLab ‚Äî Modelo de Competitividade da Cabotagem em rela√ß√£o ao Modal Rodovi√°rio</title>

  <!-- Leaflet (Mapa) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #007bff;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --light: #f8f9fa;
      --dark: #343a40;
      --blue-dark: #1e6dbb;
      --purple-bg: #e6e6fa;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }

    /* Navbar fixa */
    .navbar {
      background: var(--primary);
      color: white;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .navbar .logo {
      font-size: 1.4rem;
      font-weight: bold;
    }

    .navbar ul {
      list-style: none;
      display: flex;
      gap: 20px;
      margin: 0;
      padding: 0;
    }

    .navbar a {
      color: white;
      text-decoration: none;
      font-weight: 500;
      font-size: 0.95rem;
    }

    .navbar a:hover {
      text-decoration: underline;
    }

    .container {
      display: grid;
      grid-template-columns: 1fr 2fr 1fr;
      gap: 16px;
      padding: 16px;
      max-width: 1400px;
      margin: 0 auto;
    }

    @media (max-width: 992px) {
      .container {
        grid-template-columns: 1fr;
        padding: 12px;
      }
      .col-purple {
        order: -1; /* Mapa no topo em mobile */
      }
    }

    .col-blue {
      background: var(--blue-dark);
      color: white;
      padding: 20px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.7;
    }

    .col-blue a {
      color: #a0d4ff;
      text-decoration: underline;
    }

    .col-green {
      background: #f0f8f0;
      padding: 20px;
      border-radius: 8px;
      font-size: 14px;
    }

    .col-purple {
      background: var(--purple-bg);
      padding: 0;
      border-radius: 8px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .col-purple #map {
      height: 500px;
      width: 100%;
      border: none;
      flex-grow: 1;
    }

    @media (max-width: 768px) {
      .col-purple #map {
        height: 350px;
      }
    }

    .footer-contact {
      background: var(--success);
      color: white;
      text-align: center;
      padding: 10px;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
      font-weight: 500;
    }

    h2 {
      color: var(--dark);
      margin-top: 20px;
      margin-bottom: 12px;
      font-size: 18px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .input-container {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .input-container input {
      flex: 1;
      min-width: 140px;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 15px;
      background: white;
    }

    button {
      padding: 10px 16px;
      margin: 6px 0;
      width: 100%;
      border: none;
      border-radius: 6px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    #consultar { background: var(--primary); color: white; }
    #consultar:hover { background: #0056b3; }
    #limpar { background: #6c757d; color: white; }
    #limpar:hover { background: #5a6268; }
    #salvar-grafico { 
      background: var(--success); 
      color: white; 
      margin-top: 16px; 
      display: none;
    }
    #salvar-grafico:hover { background: #218838; }

    .armador-card {
      background: white;
      padding: 14px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      text-align: center;
      margin: 8px;
      min-height: 90px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: transform 0.2s;
    }

    .armador-card:hover {
      transform: translateY(-2px);
    }

    .armador-card.competitivo {
      background: #e8f5e8;
      border: 2px solid var(--success);
    }

    .armador-card.nao-competitivo {
      background: #ffeaea;
      border: 2px solid var(--danger);
      color: #c00;
    }

    .armador-icon {
      font-size: 28px;
      margin-bottom: 6px;
    }

    .chart-container {
      margin-top: 20px;
      height: 280px;
      position: relative;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .info-item {
      background: white;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      text-align: center;
    }

    .info-item label {
      font-weight: bold;
      font-size: 12px;
      color: #666;
      display: block;
      margin-bottom: 4px;
    }

    .info-item span {
      font-size: 16px;
      font-weight: 600;
    }

    .visitante-sep {
      margin-top: 24px;
      padding-top: 16px;
      border-top: 2px solid rgba(255,255,255,0.4);
      font-weight: bold;
    }

    .dados-titulo {
      font-size: 18px;
      font-weight: bold;
      color: var(--dark);
      margin-top: 18px;
      margin-bottom: 10px;
      text-align: center;
    }

    .historico-box {
      margin-top: 20px;
      padding: 12px;
      background: rgba(0,0,0,0.1);
      border-radius: 6px;
    }

    .historico-box h3 {
      margin-top: 0;
      font-size: 16px;
    }

    .historico-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 120px;
      overflow-y: auto;
    }

    .historico-list li {
      padding: 6px 0;
      font-size: 13px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }

    .historico-list li:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body>

  <!-- Navbar fixa -->
  <nav class="navbar">
    <div class="logo">RouteLab - Modelo de Competitividade da Cabotagem em rela√ß√£o ao Modal Rodovi√°rio</div>
    <ul>
      <li><a href="/competitividade">üîΩ An√°lise das Cidades</a></li>
    </ul>
  </nav>

  <div class="container">
    <!-- Coluna 1: Informa√ß√µes -->
    <div class="col-blue">
      <p>
        Este aplicativo √© resultado da pesquisa publicada no artigo 
        <strong>"Brazilian maritime containerized cabotage competitiveness assessment based on a multimodal super network"</strong>. 
        O artigo est√° dispon√≠vel em 
        <a href="https://doi.org/10.1016/j.jtrangeo.2024.104062" target="_blank">
          https://doi.org/10.1016/j.jtrangeo.2024.104062
        </a>.
      </p>
      <br>
      <p>
        Com objetivo promover o modal Cabotagem em sua regi√£o de competitividade, este aplicativo verifica se a Cabotagem √© mais competitiva que o modal Rodovi√°rio para as 637 cidades com mais de 50 mil habitantes.
      </p>
      <br>
      <p>
        S√£o considerados o frete base, o custo de invent√°rio em tr√¢nsito e o custo de emiss√£o de CO‚ÇÇ equivalente.
      </p>

      <div class="visitante-sep">
        <h2>Visitantes</h2>
        <div style="font-size: 28px; font-weight: bold; margin-top: 8px;">
          <span id="visitantes">0</span>
        </div>
      </div>

      <!-- Hist√≥rico de consultas -->
      <div class="historico-box">
        <h3>üîç Consultas Recentes</h3>
        <ul id="historico-list" class="historico-list"></ul>
      </div>
    </div>

    <!-- Coluna 2: Formul√°rio + Resultados -->
    <div class="col-green">
      <h2>üìç Selecione as cidades de origem e destino</h2>
      <div class="input-container">
        <input list="cidades" id="origem" placeholder="Cidade de origem" autocomplete="off" />
        <input list="cidades" id="destino" placeholder="Cidade de destino" autocomplete="off" />
      </div>

      <button id="consultar" onclick="consultar()">Consultar Rota</button>
      <button id="limpar" onclick="limpar()">Limpar</button>

      <div id="resultado" style="display:none;">
        <div class="dados-titulo">üìä Dados da Rota</div>
        <div class="info-grid">
          <div class="info-item">
            <label>Dist√¢ncia (km)</label>
            <span id="distancia">-</span>
          </div>
          <div class="info-item">
            <label>Tempo (horas)</label>
            <span id="tempo">-</span>
          </div>
          <div class="info-item">
            <label>CO‚ÇÇ ‚Äî Padr√£o</label>
            <span id="emissao_padrao">-</span> <small>kg</small>
          </div>
        </div>

        <h2>üö¢ Competitividade dos Armadores</h2>
        <div class="info-grid">
          <div class="armador-card" id="armador1">
            <div class="armador-icon">1Ô∏è‚É£</div>
            <div>Armador 1</div>
            <div id="status1">-</div>
          </div>
          <div class="armador-card" id="armador2">
            <div class="armador-icon">2Ô∏è‚É£</div>
            <div>Armador 2</div>
            <div id="status2">-</div>
          </div>
          <div class="armador-card" id="armador3">
            <div class="armador-icon">3Ô∏è‚É£</div>
            <div>Armador 3</div>
            <div id="status3">-</div>
          </div>
          <div class="armador-card" id="armador4">
            <div class="armador-icon">4Ô∏è‚É£</div>
            <div>Armador 4</div>
            <div id="status4">-</div>
          </div>
        </div>

        <h2>üìä Compara√ß√£o de Emiss√µes de CO‚ÇÇ (kg)</h2>
        <div class="chart-container">
          <canvas id="emissionsChart"></canvas>
        </div>
      </div>

      <button id="salvar-grafico" onclick="salvarGrafico()">üì• Salvar Gr√°fico</button>
    </div>

    <!-- Coluna 3: Mapa -->
    <div class="col-purple">
      <div id="map"></div>
      <div class="footer-contact">
        Contato: costa@usp.br
      </div>
    </div>
  </div>

  <datalist id="cidades"></datalist>

  <script>
    // Contador de visitantes
    let totalVisitas = parseInt(localStorage.getItem('totalVisitas') || '0') + 1;
    localStorage.setItem('totalVisitas', totalVisitas);
    document.getElementById('visitantes').textContent = totalVisitas.toLocaleString('pt-BR');

    // Carregar hist√≥rico
    function carregarHistorico() {
      const historico = JSON.parse(localStorage.getItem('routelab_historico') || '[]');
      const list = document.getElementById('historico-list');
      list.innerHTML = '';
      historico.slice(-5).reverse().forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.origem} ‚Üí ${item.destino}`;
        list.appendChild(li);
      });
    }
    carregarHistorico();

    // ‚úÖ CORRE√á√ÉO: URL da API sem espa√ßos
   const API_BASE = 
  window.location.hostname.includes('localhost')
    ? 'http://localhost:8000'
    : 'https://projeto-site-routelab.onrender.com';

    let allCities = [];

    fetch(`${API_BASE}/cities`)
      .then(r => r.json())
      .then(data => {
        allCities = data.cities || [];
        updateDatalist(allCities);
      })
      .catch(err => {
        console.error('Erro ao carregar cidades:', err);
      });

    function updateDatalist(cities) {
      const datalist = document.getElementById('cidades');
      datalist.innerHTML = '';
      cities.forEach(cidade => {
        const option = document.createElement('option');
        option.value = cidade;
        datalist.appendChild(option);
      });
    }

    function limpar() {
      document.getElementById('origem').value = '';
      document.getElementById('destino').value = '';
      document.getElementById('resultado').style.display = 'none';
      document.getElementById('salvar-grafico').style.display = 'none';
      const existingChart = Chart.getChart('emissionsChart');
      if (existingChart) existingChart.destroy();
      if (window.rotaMap) {
        window.rotaMap.remove();
        delete window.rotaMap;
      }
    }

    async function consultar() {
      const origemInput = document.getElementById('origem').value.trim();
      const destinoInput = document.getElementById('destino').value.trim();

      if (!origemInput || !destinoInput) {
        alert("Por favor, preencha ambas as cidades.");
        return;
      }

      // Salvar no hist√≥rico
      const historico = JSON.parse(localStorage.getItem('routelab_historico') || '[]');
      historico.push({ origem: origemInput, destino: destinoInput, data: new Date().toISOString() });
      localStorage.setItem('routelab_historico', JSON.stringify(historico.slice(-10)));
      carregarHistorico();

      document.getElementById('resultado').style.display = 'block';
      document.getElementById('salvar-grafico').style.display = 'none';

      try {
        const response = await fetch(`${API_BASE}/route`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ origin: origemInput, destination: destinoInput })
        });

        if (!response.ok) throw new Error(`Erro na API: ${response.status}`);

        const data = await response.json();

        if (data.success && data.info) {
          const info = data.info;

          document.getElementById('distancia').textContent = (info.pathDistanceWithoutBR319 || 0).toFixed(2);
          document.getElementById('tempo').textContent = (info.pathTransitTimeWithoutBR319 || 0).toFixed(2);
          document.getElementById('emissao_padrao').textContent = (info.emissao_sem_br319 || 0).toFixed(2);

          const armadores = [
            { id: 'armador1', statusId: 'status1', flag: info.isAL10 },
            { id: 'armador2', statusId: 'status2', flag: info.isLG10 },
            { id: 'armador3', statusId: 'status3', flag: info.isML10 },
            { id: 'armador4', statusId: 'status4', flag: info.isNC10 }
          ];

          armadores.forEach(a => {
            const card = document.getElementById(a.id);
            const status = document.getElementById(a.statusId);
            card.classList.remove('competitivo', 'nao-competitivo');
            if (a.flag) {
              card.classList.add('competitivo');
              status.textContent = 'Competitivo';
            } else {
              card.classList.add('nao-competitivo');
              status.textContent = 'N√£o competitivo';
            }
          });

          generateEmissionsChart(info);
          document.getElementById('salvar-grafico').style.display = 'block';
          mostrarMapa(info);

        } else {
          alert(data.message || "Rota n√£o encontrada");
        }

      } catch (err) {
        alert(`Erro: ${err.message}`);
        console.error('Erro na consulta:', err);
      }
    }

    function generateEmissionsChart(info) {
      const ctx = document.getElementById('emissionsChart').getContext('2d');
      const existingChart = Chart.getChart('emissionsChart');
      if (existingChart) existingChart.destroy();

      const values = [
        info.emissao_sem_br319 || 0,
        info.emissao_al || 0,
        info.emissao_lg || 0,
        info.emissao_ml || 0,
        info.emissao_nc || 0
      ].map(v => parseFloat(v) || 0);

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Rodovi√°rio', 'Armador 1', 'Armador 2', 'Armador 3', 'Armador 4'],
          datasets: [{
            label: 'Emiss√µes de CO‚ÇÇ (kg)',
            data: values,
            backgroundColor: [
              '#ff6b6b',
              '#4ecdc4',
              '#45b7d1',
              '#96ceb4',
              '#f9ca24'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const value = context.raw.toFixed(2);
                  return `${context.label}: ${value} kg`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Emiss√µes de CO‚ÇÇ (kg)' }
            }
          }
        }
      });
    }

    function salvarGrafico() {
      const canvas = document.getElementById('emissionsChart');
      const link = document.createElement('a');
      link.download = `routelab-co2-${new Date().toISOString().slice(0,10)}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    }

    function mostrarMapa(info) {
      const mapDiv = document.getElementById('map');
      if (window.rotaMap) {
        window.rotaMap.remove();
      }

      const map = L.map('map').setView([-14.2350, -51.9253], 4);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
      }).addTo(map);

      const boundsArray = [];

      if (info.originLat != null && info.originLon != null) {
        L.marker([info.originLat, info.originLon])
          .bindPopup(`<b>Origem</b><br>${info.origin}<br>(${info.originLat.toFixed(4)}, ${info.originLon.toFixed(4)})`)
          .addTo(map);
        boundsArray.push([info.originLat, info.originLon]);
      }

      if (info.destinationLat != null && info.destinationLon != null) {
        L.marker([info.destinationLat, info.destinationLon])
          .bindPopup(`<b>Destino</b><br>${info.destination}<br>(${info.destinationLat.toFixed(4)}, ${info.destinationLon.toFixed(4)})`)
          .addTo(map);
        boundsArray.push([info.destinationLat, info.destinationLon]);
      }

      if (boundsArray.length === 2) {
        L.polyline(boundsArray, {
          color: '#e74c3c',
          weight: 4,
          opacity: 0.9
        }).addTo(map);
        map.fitBounds(L.latLngBounds(boundsArray).pad(0.2));
      } else if (boundsArray.length > 0) {
        map.setView(boundsArray[0], 6);
      }

      window.rotaMap = map;
    }
  </script>
</body>
</html>