<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Modelo de Competitividade da Cabotagem</title>

  <!-- Leaflet (Mapa) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f7fa;
      color: #333;
    }

    .header {
      background: #007bff;
      color: white;
      text-align: center;
      padding: 10px 0;
      font-size: 20px;
      font-weight: bold;
    }

    .container {
      display: grid;
      grid-template-columns: 1fr 2fr 1fr;
      gap: 10px;
      padding: 10px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .col-blue {
      background: #1e6dbb;
      color: white;
      padding: 15px;
      border-radius: 5px;
      font-size: 14px;
      line-height: 1.6;
    }

    .col-green {
      background: #d4f0d4;
      padding: 15px;
      border-radius: 5px;
      font-size: 14px;
    }

    .col-purple {
      background: #e6e6fa;
      padding: 0;
      border-radius: 5px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .col-purple #map {
      height: 450px;
      width: 100%;
      border: none;
      flex-grow: 1;
    }

    .footer-contact {
      background: #28a745;
      color: white;
      text-align: center;
      padding: 8px;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
    }

    h2 {
      color: #000;
      margin-top: 20px;
      margin-bottom: 10px;
      font-size: 18px;
      font-weight: bold;
    }

    .input-container {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .input-container input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      background: yellow;
    }

    button {
      padding: 8px 12px;
      margin: 5px 0;
      width: 100%;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
    }

    #consultar { background: #007bff; color: white; }
    #consultar:hover { background: #0056b3; }
    #limpar { background: #6c757d; color: white; }
    #salvar-grafico { 
      background: #28a745; 
      color: white; 
      margin-top: 10px; 
      display: none;
    }

    .armador-card {
      background: #fff;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      text-align: center;
      margin: 5px;
      min-height: 80px;
    }

    .armador-card.competitivo {
      background: #d4f0d4;
      border: 2px solid #28a745;
    }

    .armador-card.nao-competitivo {
      background: #ffebee;
      border: 2px solid #f44336;
      color: #c62828;
    }

    .armador-icon {
      font-size: 24px;
      margin-bottom: 5px;
    }

    .chart-container {
      margin-top: 15px;
      height: 250px;
      position: relative;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .info-item {
      background: #fff;
      padding: 8px;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      text-align: center;
    }

    .info-item label {
      font-weight: bold;
      font-size: 12px;
      color: #7f8c8d;
    }

    .info-item span {
      font-size: 14px;
    }

    .emissao-box {
      background: #fff;
      padding: 8px;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      text-align: center;
      margin: 5px;
    }

    .emissao-box label {
      font-weight: bold;
      font-size: 12px;
      color: #7f8c8d;
      display: block;
    }

    .emissao-box span {
      font-size: 14px;
    }

    .visitante-sep {
      margin-top: 20px;
      padding-top: 10px;
      border-top: 2px solid rgba(255,255,255,0.3);
      font-weight: bold;
    }

    .dados-titulo {
      font-size: 16px;
      font-weight: bold;
      color: #000;
      margin-top: 15px;
      margin-bottom: 5px;
      text-align: center;
    }

    .coordenadas {
      font-size: 12px;
      color: #555;
      margin: 5px 0;
      padding: 5px;
      background: #f9f9f9;
      border-radius: 5px;
      text-align: center;
    }

    /* Estiliza√ß√£o do mapa */
    .leaflet-container {
      background: #e6e6fa;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <div class="header">
    Modelo de Competitividade da Cabotagem em rela√ß√£o ao Modal Rodovi√°rio
  </div>

  <div class="container">
    <!-- Coluna 1: Informa√ß√µes e Visitantes -->
    <div class="col-blue">
      <p>
        Este aplicativo √© resultado da pesquisa publicada no artigo 
        <strong>"Brazilian maritime containerized cabotage competitiveness assessment based on a multimodal super network"</strong>. 
        O artigo est√° dispon√≠vel em <a href="https://doi.org/10.1016/j.jtrangeo.2024.104062" style="color:white; text-decoration:underline;">https://doi.org/10.1016/j.jtrangeo.2024.104062</a>.
      </p>
      <br>
      <p>
        Com objetivo promover o modal Cabotagem em sua regi√£o de competitividade, este aplicativo verifica se o Cabotagem √© mais competitiva que o modal Rodovi√°rio para as 637 Cidades com mais de 50 mil habitantes.
      </p>
      <br>
      <p>
        S√£o considerados o frete base, o custo de invent√°rio em tr√¢nsito e o custo de emiss√£o de CO‚ÇÇ equivalente.
      </p>

      <div class="visitante-sep">
        <h2>Agradecemos sua visita. Voc√™ √© o Visitante n√∫mero:</h2>
        <div style="font-size: 24px; font-weight: bold; margin-top: 5px;">
          <span id="visitantes">0</span>
        </div>
      </div>
    </div>

    <!-- Coluna 2: Formul√°rio, Resultado, Gr√°fico -->
    <div class="col-green">
      <h2>üîç Selecione as cidades de origem e destino</h2>
      <div class="input-container">
        <input list="cidades" id="origem" placeholder="Origem" />
        <input list="cidades" id="destino" placeholder="Destino" />
      </div>

      <button id="consultar" onclick="consultar()">Consultar Rota</button>
      <button id="limpar" onclick="limpar()">Limpar</button>

      <div id="resultado" style="display:none;">
        <div class="dados-titulo">üìä Dados da Rota</div>
        <div class="info-grid">
          <div class="info-item">
            <label>Dist√¢ncia (km)</label>
            <span id="distancia">-</span>
          </div>
          <div class="info-item">
            <label>Tempo (horas)</label>
            <span id="tempo">-</span>
          </div>
          <div class="info-item">
            <label>Emiss√£o CO‚ÇÇ ‚Äî Padr√£o</label>
            <span id="emissao_padrao">-</span> <small>kg</small>
          </div>
        </div>

        <div class="coordenadas">
          <strong>Origem:</strong> <span id="origem_lat">-</span>, <span id="origem_lon">-</span><br>
          <strong>Destino:</strong> <span id="destino_lat">-</span>, <span id="destino_lon">-</span>
        </div>

        <h2>üö¢ Competitividade dos Armadores</h2>
        <div class="info-grid">
          <div class="armador-card" id="armador1">
            <div class="armador-icon">‚úÖ</div>
            <div>Armador 1</div>
            <div id="status1">Competitivo</div>
          </div>
          <div class="armador-card" id="armador2">
            <div class="armador-icon">‚úÖ</div>
            <div>Armador 2</div>
            <div id="status2">Competitivo</div>
          </div>
          <div class="armador-card" id="armador3">
            <div class="armador-icon">‚úÖ</div>
            <div>Armador 3</div>
            <div id="status3">Competitivo</div>
          </div>
          <div class="armador-card" id="armador4">
            <div class="armador-icon">‚úÖ</div>
            <div>Armador 4</div>
            <div id="status4">Competitivo</div>
          </div>
        </div>

        <h2>üìä Compara√ß√£o de Emiss√µes de CO‚ÇÇeq (ton)</h2>
        <div class="chart-container">
          <canvas id="emissionsChart"></canvas>
        </div>
      </div>

      <button id="salvar-grafico" onclick="salvarGrafico()">üì• Salvar Gr√°fico</button>
    </div>

    <!-- Coluna 3: Mapa + Contato -->
    <div class="col-purple">
      <div id="map"></div>
      <div class="footer-contact">
        Contato: costa@usp.br
      </div>
    </div>
  </div>

  <datalist id="cidades"></datalist>

  <script>
    // Contador total de visitantes
    let totalVisitas = parseInt(localStorage.getItem('totalVisitas') || '0') + 1;
    localStorage.setItem('totalVisitas', totalVisitas);
    document.getElementById('visitantes').textContent = totalVisitas;

    const API_BASE = window.location.hostname === 'localhost' 
      ? 'http://localhost:8000' 
      : 'https://projeto-site-routelab.onrender.com';

    let allCities = [];

    fetch(`${API_BASE}/cities`)
      .then(r => r.json())
      .then(data => {
        allCities = data.cities;
        updateDatalist(allCities);
      })
      .catch(err => {
        console.error('Erro ao carregar cidades:', err);
        alert('Erro ao conectar ao servidor.');
      });

    function updateDatalist(cities) {
      const datalist = document.getElementById('cidades');
      datalist.innerHTML = '';
      cities.forEach(cidade => {
        const option = document.createElement('option');
        option.value = cidade;
        datalist.appendChild(option);
      });
    }

    function limpar() {
      document.getElementById('origem').value = '';
      document.getElementById('destino').value = '';
      document.getElementById('resultado').style.display = 'none';
      document.getElementById('map').style.display = 'none';
      document.getElementById('salvar-grafico').style.display = 'none';
      const existingChart = Chart.getChart('emissionsChart');
      if (existingChart) existingChart.destroy();
    }

    async function consultar() {
      const origemInput = document.getElementById('origem').value.trim();
      const destinoInput = document.getElementById('destino').value.trim();

      if (!origemInput || !destinoInput) {
        alert("Por favor, preencha ambas as cidades.");
        return;
      }

      document.getElementById('resultado').style.display = 'block';
      document.getElementById('map').style.display = 'none';
      document.getElementById('salvar-grafico').style.display = 'none';

      try {
        const response = await fetch(`${API_BASE}/route`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ origin: origemInput, destination: destinoInput })
        });

        if (!response.ok) throw new Error(`Erro na API: ${response.status}`);

        const data = await response.json();

        if (data.success) {
          const info = data.info;
          console.log("üîç Dados recebidos do backend:", info);
          // Atualizar dados visuais
          document.getElementById('distancia').textContent = info.pathDistanceWithoutBR319?.toFixed(2) || '-';
          document.getElementById('tempo').textContent = info.pathTransitTimeWithoutBR319?.toFixed(2) || '-';
          document.getElementById('emissao_padrao').textContent = info.emissao_sem_br319?.toFixed(2) || '-';

         
          // Atualizar competitividade dos armadores
          const armadores = [
            { id: 'armador1', statusId: 'status1', flag: info.isAL10 },
            { id: 'armador2', statusId: 'status2', flag: info.isLG10 },
            { id: 'armador3', statusId: 'status3', flag: info.isML10 },
            { id: 'armador4', statusId: 'status4', flag: info.isNC10 }
          ];

          armadores.forEach(a => {
            const card = document.getElementById(a.id);
            const status = document.getElementById(a.statusId);
            if (a.flag) {
              card.classList.add('competitivo');
              card.classList.remove('nao-competitivo');
              status.textContent = 'Competitivo';
            } else {
              card.classList.remove('competitivo');
              card.classList.add('nao-competitivo');
              status.textContent = 'N√£o competitivo';
            }
          });

          generateEmissionsChart(info);
          document.getElementById('salvar-grafico').style.display = 'block';
          mostrarMapa(info);

        } else {
          alert(data.message || "Rota n√£o encontrada");
        }

      } catch (err) {
        alert(`Erro: ${err.message}`);
        console.error('Erro na consulta:', err);
      }
    }

    function generateEmissionsChart(info) {
      const ctx = document.getElementById('emissionsChart').getContext('2d');
      const existingChart = Chart.getChart('emissionsChart');
      if (existingChart) existingChart.destroy();

      const values = [
        info.emissao_sem_br319 || 0,
        info.emissao_al || 0,
        info.emissao_lg || 0,
        info.emissao_ml || 0,
        info.emissao_nc || 0
      ];

      const safeValues = values.map(v => {
        const num = parseFloat(v);
        return isNaN(num) ? 0 : num;
      });

      const labels = ['Rodovi√°rio', '1', '2', '3', '4'];
      const colors = ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff'];

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Emiss√µes de CO‚ÇÇ (kg)',
            data: safeValues,
            backgroundColor: colors,
            borderColor: colors.map(c => c.replace('ff', 'cc')),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const value = context.raw?.toFixed(2) || '0';
                  return `${context.label}: ${value} kg`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Emiss√µes de CO‚ÇÇ (kg)' }
            },
            x: {
              title: { display: true, text: 'Armadores' }
            }
          }
        }
      });
    }

    function salvarGrafico() {
      const canvas = document.getElementById('emissionsChart');
      const link = document.createElement('a');
      link.download = 'emissoes-co2-routelab.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    }

    function mostrarMapa(info) {
      const mapDiv = document.getElementById('map');
      mapDiv.style.display = 'block';

      if (window.rotaMap) {
        window.rotaMap.remove();
      }

      const map = L.map('map').setView([-14.2350, -51.9253], 4);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
      }).addTo(map);

      const boundsArray = [];

      if (info.originLat != null && info.originLon != null) {
        L.marker([info.originLat, info.originLon])
          .bindPopup(`<b>Origem</b><br>(${info.originLat.toFixed(4)}, ${info.originLon.toFixed(4)})`)
          .addTo(map);
        boundsArray.push([info.originLat, info.originLon]);
      }

      if (info.destinationLat != null && info.destinationLon != null) {
        L.marker([info.destinationLat, info.destinationLon])
          .bindPopup(`<b>Destino</b><br>(${info.destinationLat.toFixed(4)}, ${info.destinationLon.toFixed(4)})`)
          .addTo(map);
        boundsArray.push([info.destinationLat, info.destinationLon]);
      }

      if (boundsArray.length === 2) {
        L.polyline(boundsArray, {
          color: '#e74c3c',
          weight: 3,
          opacity: 0.8,
          dashArray: '8,6'
        }).addTo(map);
        map.fitBounds(L.latLngBounds(boundsArray).pad(0.2));
      } else if (boundsArray.length > 0) {
        map.fitBounds(L.latLngBounds(boundsArray).pad(0.3));
      }

      window.rotaMap = map;
    }
  </script>
</body>
</html>