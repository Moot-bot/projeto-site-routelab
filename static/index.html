<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Consultor de Rotas Log√≠sticas</title>

  <!-- Leaflet (Mapa) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 40px;
      background: #f5f7fa;
      color: #333;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .input-container {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }
    .input-container input {
      flex: 1;
      min-width: 0;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }
    button {
      padding: 12px;
      margin: 6px 0;
      width: 100%;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    #consultar { background: #3498db; color: white; }
    #consultar:hover { background: #2980b9; }
    #limpar { background: #95a5a6; color: white; }
    #salvar-grafico { 
      background: #2ecc71; 
      color: white; 
      margin-top: 12px; 
      display: none;
    }

    #resultado {
      margin-top: 20px;
      padding: 15px;
      background: #e8f4f8;
      border-left: 4px solid #3498db;
      border-radius: 5px;
      display: none;
    }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .info-item {
      background: #fff;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .info-item label {
      font-weight: bold;
      font-size: 12px;
      color: #7f8c8d;
    }
    .info-item span {
      font-size: 14px;
    }
    .emissao-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    .emissao-box {
      background: #fff;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      text-align: center;
    }
    .emissao-box label {
      font-weight: bold;
      font-size: 12px;
      color: #7f8c8d;
      display: block;
    }
    .emissao-box span {
      font-size: 14px;
    }
    .chart-container {
      margin-top: 20px;
      height: 300px;
      position: relative;
    }
    /* Linha tempor√°ria para debug visual do canvas */
    #emissionsChart {
      border: 1px solid #eee;
    }
    #map {
      height: 250px;
      border-radius: 8px;
      margin-top: 20px;
      display: none;
    }
    .competitividade-navios {
      margin-top: 25px;
      padding: 18px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-top: 3px solid #3498db;
    }
    .competitividade-navios h4 {
      margin-top: 0;
      color: #2c3e50;
      font-size: 18px;
    }
    .navios-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .navio-card {
      text-align: center;
      padding: 14px 8px;
      border-radius: 8px;
      font-weight: bold;
      transition: transform 0.2s;
    }
    .navio-card.competitivo {
      background-color: #e8f5e9;
      border: 2px solid #4caf50;
      color: #2e7d32;
    }
    .navio-card.nao-competitivo {
      background-color: #ffebee;
      border: 2px solid #f44336;
      color: #c62828;
    }
    .navio-icon {
      font-size: 28px;
      margin-bottom: 6px;
    }
    .navio-nome {
      font-size: 14px;
      margin-bottom: 4px;
    }
    .navio-status {
      font-size: 12px;
      opacity: 0.9;
    }
    .footer {
      text-align: center;
      font-size: 12px;
      color: #7f8c8d;
      margin-top: 25px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Consultor de Rotas Log√≠sticas</h1>

    <div class="input-container">
      <input list="cidades" id="origem" placeholder="Origem" />
      <input list="cidades" id="destino" placeholder="Destino" />
    </div>

    <button id="consultar" onclick="consultar()">Consultar Rota</button>
    <button id="limpar" onclick="limpar()">Limpar</button>

    <div id="resultado"></div>
    <button id="salvar-grafico" onclick="salvarGrafico()">üì• Salvar Gr√°fico</button>
    <div id="map"></div>

    <div class="footer">
      üë• Visitantes nesta sess√£o: <span id="visitantes">1</span>
    </div>

    <datalist id="cidades"></datalist>
  </div>

  <script>
    // Contador de visitantes (por sess√£o)
    let visitas = parseInt(sessionStorage.getItem('visitas') || '0') + 1;
    sessionStorage.setItem('visitas', visitas);
    document.getElementById('visitantes').textContent = visitas;

    const API_BASE = window.location.hostname === 'localhost' 
      ? 'http://localhost:8000' 
      : 'https://projeto-site-routelab.onrender.com';

    let allCities = [];
    let cityCoords = {};

    // Carregar coordenadas do arquivo CORRETO: cidade.csv
    fetch('https://github.com/Moot-bot/Routelab/releases/download/v1.1/cidade.csv')
      .then(response => {
        if (!response.ok) throw new Error('Falha ao carregar cidade.csv');
        return response.text();
      })
      .then(csvText => {
        const lines = csvText.split('\n').slice(1); // pula cabe√ßalho
        cityCoords = {};
        lines.forEach(line => {
          if (!line.trim()) return;
          const parts = line.split(';');
          if (parts.length >= 6) {
            const [, nodeName, , , nodeLat, nodeLon] = parts;
            if (nodeName && nodeLat && nodeLon) {
              cityCoords[nodeName.trim()] = {
                lat: parseFloat(nodeLat.replace(',', '.')),
                lon: parseFloat(nodeLon.replace(',', '.'))
              };
            }
          }
        });
        console.log('‚úÖ Coordenadas carregadas:', Object.keys(cityCoords).length);
      })
      .catch(err => {
        console.error('Erro ao carregar cidade.csv:', err);
      });

    // Carregar lista de cidades para o datalist
    fetch(`${API_BASE}/cities`)
      .then(r => r.json())
      .then(data => {
        allCities = data.cities;
        updateDatalist(allCities);
      })
      .catch(err => {
        console.error('Erro ao carregar cidades:', err);
        alert('Erro ao conectar ao servidor.');
      });

    function updateDatalist(cities) {
      const datalist = document.getElementById('cidades');
      datalist.innerHTML = '';
      cities.forEach(cidade => {
        const option = document.createElement('option');
        option.value = cidade;
        datalist.appendChild(option);
      });
    }

    function limpar() {
      document.getElementById('origem').value = '';
      document.getElementById('destino').value = '';
      document.getElementById('resultado').style.display = 'none';
      document.getElementById('map').style.display = 'none';
      document.getElementById('salvar-grafico').style.display = 'none';
      const existingChart = Chart.getChart('emissionsChart');
      if (existingChart) existingChart.destroy();
    }

    async function consultar() {
      const origem = document.getElementById('origem').value.trim();
      const destino = document.getElementById('destino').value.trim();
      const resultado = document.getElementById('resultado');

      if (!origem || !destino) {
        alert("Por favor, preencha ambas as cidades.");
        return;
      }

      resultado.style.display = 'block';
      resultado.innerHTML = '<p>üîé Buscando rota...</p>';
      document.getElementById('map').style.display = 'none';
      document.getElementById('salvar-grafico').style.display = 'none';

      try {
        const response = await fetch(`${API_BASE}/route`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ origin: origem, destination: destino })
        });

        if (!response.ok) throw new Error(`Erro na API: ${response.status}`);

        const data = await response.json();

        if (data.success) {
          const info = data.info;

          resultado.innerHTML = `
            <h3 id="rota-titulo">Rota: ${origem} ‚Üí ${destino}</h3>

            <div class="info-grid">
              <div class="info-item">
                <label>Dist√¢ncia (km)</label>
                <span>${info.pathDistanceWithoutBR319?.toFixed(2) || '-'} km</span>
              </div>
              <div class="info-item">
                <label>Tempo (horas)</label>
                <span>${info.pathTransitTimeWithoutBR319?.toFixed(2) || '-'} h</span>
              </div>
              <div class="info-item">
                <label>Emiss√£o CO‚ÇÇ ‚Äî Padr√£o</label>
                <span>${info.emissao_sem_br319?.toFixed(2) || '-'} <small>kg</small></span>
              </div>
            </div>

            <div class="emissao-row">
              <div class="emissao-box">
                <label>1</label>
                <span>${info.emissao_al?.toFixed(2) || '-'} <small>kg</small></span>
              </div>
              <div class="emissao-box">
                <label>2</label>
                <span>${info.emissao_lg?.toFixed(2) || '-'} <small>kg</small></span>
              </div>
              <div class="emissao-box">
                <label>3</label>
                <span>${info.emissao_ml?.toFixed(2) || '-'} <small>kg</small></span>
              </div>
              <div class="emissao-box">
                <label>4</label>
                <span>${info.emissao_nc?.toFixed(2) || '-'} <small>kg</small></span>
              </div>
            </div>

            <h4 style="margin-top: 20px;">üìä Compara√ß√£o de Emiss√µes de CO‚ÇÇ</h4>
            <div class="chart-container">
              <canvas id="emissionsChart"></canvas>
            </div>

            <div class="competitividade-navios">
              <h4>üö¢ Competitividade dos Armadores</h4>
              <p style="font-size: 13px; color: #555; margin-bottom: 12px;">
                Um armador √© competitivo se seu custo for at√© 10% menor que a rota padr√£o.
              </p>
              <div class="navios-grid">
                <div class="navio-card ${info.isAL10 ? 'competitivo' : 'nao-competitivo'}">
                  <div class="navio-icon">${info.isAL10 ? '‚úÖ' : '‚ùå'}</div>
                  <div class="navio-nome">Armador 1</div>
                  <div class="navio-status">${info.isAL10 ? 'Competitivo' : 'N√£o competitivo'}</div>
                </div>
                <div class="navio-card ${info.isLG10 ? 'competitivo' : 'nao-competitivo'}">
                  <div class="navio-icon">${info.isLG10 ? '‚úÖ' : '‚ùå'}</div>
                  <div class="navio-nome">Armador 2</div>
                  <div class="navio-status">${info.isLG10 ? 'Competitivo' : 'N√£o competitivo'}</div>
                </div>
                <div class="navio-card ${info.isML10 ? 'competitivo' : 'nao-competitivo'}">
                  <div class="navio-icon">${info.isML10 ? '‚úÖ' : '‚ùå'}</div>
                  <div class="navio-nome">Armador 3</div>
                  <div class="navio-status">${info.isML10 ? 'Competitivo' : 'N√£o competitivo'}</div>
                </div>
                <div class="navio-card ${info.isNC10 ? 'competitivo' : 'nao-competitivo'}">
                  <div class="navio-icon">${info.isNC10 ? '‚úÖ' : '‚ùå'}</div>
                  <div class="navio-nome">Armador 4</div>
                  <div class="navio-status">${info.isNC10 ? 'Competitivo' : 'N√£o competitivo'}</div>
                </div>
              </div>
            </div>
          `;

          generateEmissionsChart(info);
          highlightBestRoute(info);
          document.getElementById('salvar-grafico').style.display = 'block';
          mostrarMapa(origem, destino);

        } else {
          resultado.innerHTML = `<p><strong>‚ùå ${data.message}</strong></p>`;
        }

      } catch (err) {
        resultado.innerHTML = `<p><strong>‚ùå Erro: ${err.message}</strong></p>`;
        console.error('Erro na consulta:', err);
      }
    }

    // ‚úÖ FUN√á√ÉO CORRIGIDA E ROBUSTA
    function generateEmissionsChart(info) {
      const ctx = document.getElementById('emissionsChart').getContext('2d');
      
      const existingChart = Chart.getChart('emissionsChart');
      if (existingChart) {
        existingChart.destroy();
      }

      const values = [
        info.emissao_sem_br319 || 0,
        info.emissao_al || 0,
        info.emissao_lg || 0,
        info.emissao_ml || 0,
        info.emissao_nc || 0
      ];

      const safeValues = values.map(v => {
        const num = parseFloat(v);
        return isNaN(num) ? 0 : num;
      });

      console.log("üìä Dados do gr√°fico:", safeValues);

      const labels = ['Padr√£o', '1', '2', '3', '4'];
      const colors = ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff'];

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Emiss√µes de CO‚ÇÇ (kg)',
            data: safeValues,
            backgroundColor: colors,
            borderColor: colors.map(c => c.replace('ff', 'cc')),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const value = context.raw?.toFixed(2) || '0';
                  return `${context.label}: ${value} kg`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Emiss√µes de CO‚ÇÇ (kg)' }
            },
            x: {
              title: { display: true, text: 'Rotas' }
            }
          }
        }
      });
    }

    function salvarGrafico() {
      const canvas = document.getElementById('emissionsChart');
      const link = document.createElement('a');
      link.download = 'emissoes-co2-routelab.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    }

    function highlightBestRoute(info) {
      const values = [
        info.emissao_sem_br319,
        info.emissao_al,
        info.emissao_lg,
        info.emissao_ml,
        info.emissao_nc
      ];
      const labels = ['Padr√£o', '1', '2', '3', '4'];
      const validValues = values.map(v => (v && !isNaN(v)) ? v : Infinity);
      const minIndex = validValues.indexOf(Math.min(...validValues));
      const melhorRota = labels[minIndex];

      if (minIndex >= 0 && isFinite(validValues[minIndex])) {
        document.getElementById('rota-titulo').innerHTML += `
          <small style="color:#28a745; font-weight:bold; display:block; margin-top:6px;">
            (Menor emiss√£o: ${melhorRota})
          </small>
        `;
      }
    }

    // ‚úÖ MAPA COM LINHA VISUAL ENTRE ORIGEM E DESTINO
    function mostrarMapa(origem, destino) {
      const mapDiv = document.getElementById('map');
      mapDiv.style.display = 'block';

      if (window.rotaMap) {
        window.rotaMap.remove();
      }

      const map = L.map('map').setView([-14.2350, -51.9253], 4);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
      }).addTo(map);

      const origemCoord = cityCoords[origem];
      const destinoCoord = cityCoords[destino];
      let boundsArray = [];

      if (origemCoord) {
        L.marker([origemCoord.lat, origemCoord.lon])
          .bindPopup(`<b>Origem:</b> ${origem}<br>(${origemCoord.lat.toFixed(4)}, ${origemCoord.lon.toFixed(4)})`)
          .addTo(map);
        boundsArray.push([origemCoord.lat, origemCoord.lon]);
      }

      if (destinoCoord) {
        L.marker([destinoCoord.lat, destinoCoord.lon])
          .bindPopup(`<b>Destino:</b> ${destino}<br>(${destinoCoord.lat.toFixed(4)}, ${destinoCoord.lon.toFixed(4)})`)
          .addTo(map);
        boundsArray.push([destinoCoord.lat, destinoCoord.lon]);
      }

      if (origemCoord && destinoCoord) {
        const polyline = L.polyline([
          [origemCoord.lat, origemCoord.lon],
          [destinoCoord.lat, destinoCoord.lon]
        ], {
          color: '#e74c3c',
          weight: 3,
          opacity: 0.8,
          dashArray: '8,6'
        }).addTo(map);

        const bounds = polyline.getBounds().pad(0.2);
        map.fitBounds(bounds);
      } else if (boundsArray.length > 0) {
        const bounds = L.latLngBounds(boundsArray).pad(0.3);
        map.fitBounds(bounds);
      }

      window.rotaMap = map;
    }
  </script>
</body>
</html>